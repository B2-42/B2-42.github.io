<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Obra — Visor</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="viewer">
    <div id="loader">Cargando obra…</div>
    <img id="obra-img" alt="Obra" />
    <div id="caption" aria-hidden="true"></div>
    <a id="back" href="/" aria-label="Volver">⟵ Volver</a>
  </div>

  <script>
    // toma ?id= y muestra /obras/<id>.(jpg|png|webp)
    (function(){
      const id = new URL(location.href).searchParams.get('id');
      const loader = document.getElementById('loader');
      const img = document.getElementById('obra-img');
      const caption = document.getElementById('caption');

      if(!id){
        loader.textContent = 'Usa esta página con el parámetro ?id=<id>. Ejemplo: ?id=obra-ejemplo';
        return;
      }

      const exts = ['jpg','png','webp'];
      let found = false;

      function tryNext(i){
        if(i>=exts.length){
          loader.textContent = 'No se encontró la imagen para id="' + id + '"';
          return;
        }
        const url = '/obras/' + encodeURIComponent(id) + '.' + exts[i];
        // intenta cargar la imagen
        const test = new Image();
        test.onload = function(){
          found = true;
          img.src = url;
          img.alt = caption.textContent || id;
          loader.style.display = 'none';
          img.style.display = 'block';
        }
        test.onerror = function(){ tryNext(i+1); }
        test.src = url;
      }

      // intenta cargar caption desde /obras/<id>.json (opcional)
      fetch('/obras/' + encodeURIComponent(id) + '.json').then(r=>{
        if(!r.ok) throw new Error('no json');
        return r.json();
      }).then(data=>{
        const parts = [];
        if(data.title) parts.push(data.title);
        if(data.author) parts.push(data.author);
        if(parts.length) caption.textContent = parts.join(' · ');
      }).catch(()=>{}).finally(()=>{ tryNext(0); });

      // permitir tap para alternar caption
      img.addEventListener('click', ()=>{
        if(caption.style.opacity === '1') caption.style.opacity = '0'; else caption.style.opacity = '1';
      });

    })();
  </script>
</body>
</html>